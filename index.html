<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMLLA CAPITAL • PRESTIGE</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        :root {
            --gold: #FFD700; --gold-dark: #b8860b; --emerald: #14F195;
            --bg: #050505; --card-bg: #0f0f0f; --border: rgba(255, 215, 0, 0.2);
        }

        body {
            background: radial-gradient(circle at 50% 30%, #1a3a1a, #050505 100%);
            color: white; font-family: 'Inter', sans-serif; min-height: 100vh;
            display: flex; justify-content: center; overflow: hidden;
        }

        .app-shell {
            width: 100%; max-width: 420px; background: rgba(5, 5, 5, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 40px;
            margin: 10px; padding: 20px 16px 90px; position: relative;
        }

        .brand-meta { font-family: 'Orbitron', sans-serif; font-size: 10px; letter-spacing: 4px; color: var(--gold); margin-bottom: 15px; text-align: center; }
        
        .balance-master { background: rgba(255, 215, 0, 0.05); border: 1px solid var(--border); border-radius: 30px; padding: 20px; text-align: center; }
        .val-display { font-size: 50px; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(255,215,0,0.5); }

        .page { display: none; animation: slideUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* THE COIN */
        .coin-portal { display: flex; justify-content: center; margin: 30px 0; }
        .engine-core {
            width: 200px; height: 200px; border-radius: 50%;
            background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 45%, #b38728 50%, #fbf5b7 55%, #aa771c 100%);
            border: 8px solid #332811; box-shadow: 0 0 40px rgba(255,215,0,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s;
        }
        .engine-core:active { transform: scale(0.92); }
        .core-text { font-size: 40px; font-weight: 900; color: #3d2b07; }

        .progress-track { height: 10px; background: #111; border-radius: 20px; border: 1px solid #333; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--emerald), var(--gold)); width: 100%; transition: width 0.3s; }

        /* CARDS */
        .task-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .btn-action { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: #000; border: none; padding: 12px 20px; border-radius: 15px; font-weight: 800; cursor: pointer; }

        /* NAVIGATION */
        .tab-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; background: rgba(10, 10, 10, 0.95); border-radius: 25px; padding: 10px; display: flex; border: 1px solid var(--border); }
        .tab-link { flex: 1; text-align: center; color: #555; font-size: 10px; font-weight: 700; cursor: pointer; }
        .tab-link.active { color: var(--gold); }
        .tab-link i { font-size: 20px; display: block; margin-bottom: 4px; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #0a0a0a; border: 2px solid var(--gold); border-radius: 30px; padding: 25px; width: 100%; max-width: 360px; text-align: center; }
        .modal-wallet { background: #000; border: 1px solid #333; padding: 12px; border-radius: 12px; font-size: 10px; margin: 15px 0; word-break: break-all; color: var(--gold); }
        input { width: 100%; background: #000; border: 1px solid #333; padding: 14px; border-radius: 12px; color: white; margin-bottom: 15px; text-align: center; outline: none; }
        
        .floating-reward { position: absolute; color: var(--gold); font-weight: 900; font-size: 30px; animation: floatUp 0.6s forwards; pointer-events: none; text-shadow: 0 0 10px gold; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
    </style>
</head>
<body>

    <div class="app-shell">
        <header>
            <div class="brand-meta">OMLLA CAPITAL</div>
            <div class="balance-master">
                <div class="val-display" id="total-balance">0</div>
                <div style="font-size: 10px; color: #888; letter-spacing: 2px;">GOLD RESERVES</div>
            </div>
        </header>

        <div id="mine-page" class="page active">
            <div class="coin-portal">
                <div class="engine-core" id="tap-engine"><div class="core-text">O$</div></div>
            </div>
            <div class="progress-track"><div class="progress-fill" id="energy-fill"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--gold);">
                <span>⚡ <span id="energy-current">1000</span></span>
                <span>MULTI: <span id="boost-status">1x</span></span>
            </div>
        </div>

        <div id="shop-page" class="page">
            <h3 style="text-align:center; color:var(--gold); margin-bottom:20px;">INVESTMENT HUB</h3>
            <div class="task-card">
                <div><b>Starter Pack</b><br><small>1,000 O$ • 0.1 SOL</small></div>
                <button class="btn-action" onclick="initiatePurchase(1000, 'Starter', 0.1)">BUY</button>
            </div>
            <div class="task-card" style="border-color: var(--emerald);">
                <div><b>Gold Pack</b><br><small>5,000 O$ • 0.5 SOL</small></div>
                <button class="btn-action" onclick="initiatePurchase(5000, 'Gold', 0.5)">BUY</button>
            </div>
        </div>

        <div id="wallet-page" class="page">
            <h3 style="text-align:center; color:var(--gold); margin-bottom:20px;">CRYPTO ASSETS</h3>
            <div class="task-card" style="flex-direction:column; text-align:center;">
                <small style="color:#666;">MERCHANT ADDRESS</small>
                <div class="modal-wallet" onclick="copyToClipboard('9eEeSQAAoKtm4Tc8njVeKLoZc4cwMhB9yr1gVsENmQEx')">
                    9eEeSQAAoKtm4Tc8njVeKLoZc4cwMhB9yr1gVsENmQEx
                </div>
                <small style="color:var(--emerald);">Tap to copy</small>
            </div>
        </div>

        <nav class="tab-bar">
            <div class="tab-link active" onclick="switchPage('mine', this)"><i class="fas fa-bolt"></i>MINE</div>
            <div class="tab-link" onclick="switchPage('shop', this)"><i class="fas fa-shopping-cart"></i>SHOP</div>
            <div class="tab-link" onclick="switchPage('wallet', this)"><i class="fas fa-wallet"></i>WALLET</div>
        </nav>
    </div>

    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h3 id="modal-pack-name" style="color:var(--gold);">Starter Pack</h3>
            <div style="font-size:30px; font-weight:900; margin:10px 0;" id="modal-sol-amount">0.1 SOL</div>
            <p style="font-size:11px; color:#888;">Paste your Transaction Signature below:</p>
            <input type="text" id="tx-signature" placeholder="Transaction Signature (ID)">
            <button class="btn-action" style="width:100%;" id="verify-btn" onclick="verifyPayment()">VERIFY BLOCKCHAIN</button>
            <button onclick="closeModal()" style="background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script>
        // CONFIG
        const RENDER_URL = "https://omlla-payments-backend.onrender.com";
        const FIREBASE_URL = "https://omllagame-default-rtdb.europe-west1.firebasedatabase.app/";
        const WALLET_ADDRESS = "9eEeSQAAoKtm4Tc8njVeKLoZc4cwMhB9yr1gVsENmQEx";

        const tg = window.Telegram.WebApp;
        tg.expand();

        firebase.initializeApp({ databaseURL: FIREBASE_URL });
        const db = firebase.database();
        const user = tg.initDataUnsafe?.user || { id: 'dev_user', first_name: 'Admin' };
        const userRef = db.ref('players/' + user.id);

        let state = { points: 0, energy: 1000 };
        let activeOrder = null;

        // LOAD DATA
        userRef.on('value', (snap) => {
            const data = snap.val();
            if (data) {
                state.points = data.points || 0;
                state.energy = data.energy !== undefined ? data.energy : 1000;
                updateUI();
            } else {
                userRef.set({ points: 0, energy: 1000, name: user.first_name });
            }
        });

        function updateUI() {
            document.getElementById('total-balance').innerText = Math.floor(state.points).toLocaleString();
            document.getElementById('energy-current').innerText = state.energy;
            document.getElementById('energy-fill').style.width = (state.energy / 10) + '%';
        }

        // TAB NAVIGATION
        window.switchPage = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            el.classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
        };

        // TAP ENGINE
        document.getElementById('tap-engine').addEventListener('pointerdown', (e) => {
            if (state.energy <= 0) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            state.points++;
            state.energy--;
            userRef.update({ points: state.points, energy: state.energy });
            
            // Visual feedback
            const rect = e.target.getBoundingClientRect();
            createFloatingText(e.clientX || rect.left + 50, e.clientY || rect.top + 50, '+1');
            tg.HapticFeedback.impactOccurred('medium');
        });

        function createFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.className = 'floating-reward';
            el.innerText = text;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        // PURCHASE FLOW
        window.initiatePurchase = async (tokens, pack, sol) => {
            tg.showConfirm(`Confirm protocol: ${pack} for ${sol} SOL?`, async (ok) => {
                if (!ok) return;
                try {
                    const res = await fetch(`${RENDER_URL}/api/create-payment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: user.id, amount: sol, pack: pack, tokens: tokens })
                    });
                    const data = await res.json();
                    if (data.success) {
                        activeOrder = { id: data.paymentId };
                        document.getElementById('modal-pack-name').innerText = pack + " Pack";
                        document.getElementById('modal-sol-amount').innerText = sol + " SOL";
                        document.getElementById('paymentModal').classList.add('active');
                        tg.openLink(`solana:${WALLET_ADDRESS}?amount=${sol}&label=OmllaCapital`);
                    }
                } catch (e) { alert("Server connection failed. Try again."); }
            });
        };

        window.verifyPayment = async () => {
            const sig = document.getElementById('tx-signature').value.trim();
            if (!sig) return alert("Please paste the TX ID");
            
            const btn = document.getElementById('verify-btn');
            btn.innerText = "VERIFYING..."; btn.disabled = true;

            try {
                const res = await fetch(`${RENDER_URL}/api/verify-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId: activeOrder.id, transactionSignature: sig })
                });
                const data = await res.json();
                if (data.success) {
                    alert("✅ SUCCESS! Tokens added to your account.");
                    closeModal();
                } else { alert("❌ Blockchain error: " + (data.error || "TX not found")); }
            } catch (e) { alert("Network error"); }
            btn.innerText = "VERIFY BLOCKCHAIN"; btn.disabled = false;
        };

        window.closeModal = () => {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('tx-signature').value = '';
        };

        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text);
            tg.HapticFeedback.notificationOccurred('success');
            alert("Address Copied!");
        };

        // Energy Regen
        setInterval(() => {
            if (state.energy < 1000) {
                state.energy = Math.min(state.energy + 1, 1000);
                userRef.child('energy').set(state.energy);
            }
        }, 3000);

    </script>
</body>
</html>
