<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMLLA CAPITAL</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --gold: #FFD700; --emerald: #14F195; --bg: #050505; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: radial-gradient(circle at 50% 0%, #1a3a1a, var(--bg) 70%); color: white; min-height: 100vh; overflow-x: hidden; text-align: center; }
        
        .logo-section { margin: 20px 0; }
        .omlla-logo { width: 70px; height: 70px; background: var(--gold); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 30px; color: black; box-shadow: 0 0 20px var(--gold); }

        .balance-card { background: rgba(20,20,20,0.8); border: 1px solid rgba(255,215,0,0.2); border-radius: 25px; padding: 25px; margin: 15px; }
        .balance-amount { font-family: 'Orbitron'; font-size: 40px; color: white; }

        .page { display: none; padding: 20px; }
        .page.active { display: block; }

        .tap-btn { width: 200px; height: 200px; border-radius: 50%; background: #111; border: 5px solid #332811; display: inline-flex; align-items: center; justify-content: center; font-size: 50px; color: var(--gold); cursor: pointer; transition: 0.1s; margin-top: 20px; }
        .tap-btn:active { transform: scale(0.9); }

        .shop-card { background: #0f0f0f; border: 1px solid #222; border-radius: 20px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-gold { background: var(--gold); color: black; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 800; cursor: pointer; }

        .nav-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; background: #0a0a0a; border-radius: 20px; padding: 12px; display: flex; justify-content: space-around; border: 1px solid #222; }
        .nav-item { color: #555; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--gold); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #0a0a0a; border: 1px solid var(--gold); border-radius: 25px; padding: 25px; width: 90%; max-width: 350px; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; margin: 15px 0; text-align: center; }
    </style>
</head>
<body>

    <div class="logo-section">
        <div class="omlla-logo">O</div>
        <p style="margin-top:10px; font-weight:800; color:var(--gold)">OMLLA CAPITAL</p>
    </div>

    <div class="balance-card">
        <p style="font-size:10px; color:var(--gold)">TOTAL OMLLA</p>
        <div class="balance-amount" id="balance-txt">0</div>
    </div>

    <div id="mine-page" class="page active">
        <div class="tap-btn" id="tap-trigger"><i class="fas fa-coins"></i></div>
        <p style="margin-top:20px; color:#888;">ENERGY: <span id="energy-txt" style="color:var(--gold)">1000</span></p>
    </div>

    <div id="shop-page" class="page">
        <div class="shop-card">
            <div style="text-align:left;"><b>Starter</b><br><small>1,000 O$ • 0.1 SOL</small></div>
            <button class="btn-gold" onclick="startOrder(1000, 'Starter', 0.1)">BUY</button>
        </div>
        <div class="shop-card">
            <div style="text-align:left;"><b>Elite</b><br><small>5,000 O$ • 0.5 SOL</small></div>
            <button class="btn-gold" onclick="startOrder(5000, 'Elite', 0.5)">BUY</button>
        </div>
    </div>

    <div id="wallet-page" class="page">
        <div style="background:#0f0f0f; padding:15px; border-radius:15px; word-break:break-all; font-size:10px; border:1px solid #222;">
            <p style="color:#666">ADMIN WALLET:</p>
            <p style="color:var(--gold)" id="adm-wallet">9eEeSQAAoKtm4Tc8njVeKLoZc4cwMhB9yr1gVsENmQEx</p>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="nav('mine', this)">MINE</div>
        <div class="nav-item" onclick="nav('shop', this)">SHOP</div>
        <div class="nav-item" onclick="nav('wallet', this)">WALLET</div>
    </nav>

    <div class="modal" id="payModal">
        <div class="modal-content">
            <h2 id="modal-pack-name" style="color:var(--gold)">Starter</h2>
            <p id="modal-price" style="margin:10px 0;">0.1 SOL</p>
            <input type="text" id="tx-input" placeholder="Paste Transaction Signature">
            <button class="btn-gold" style="width:100%" onclick="verifyPay()">VERIFY</button>
            <button class="btn-gold" style="width:100%; background:#222; color:white; margin-top:10px;" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <script>
        const RENDER_URL = "https://omlla-payments-backend.onrender.com";
        const WALLET_ADDRESS = "9eEeSQAAoKtm4Tc8njVeKLoZc4cwMhB9yr1gVsENmQEx";
        const FIREBASE_URL = "https://omllagame-default-rtdb.europe-west1.firebasedatabase.app/";

        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. Firebase Setup
        firebase.initializeApp({ databaseURL: FIREBASE_URL });
        const db = firebase.database();
        const userId = (tg.initDataUnsafe?.user?.id || "TEST_USER").toString();
        const userRef = db.ref('players/' + userId);

        let state = { points: 0, energy: 1000 };
        let currentOrder = null;

        // 2. Data Sync
        userRef.on('value', snap => {
            const data = snap.val();
            if (data) {
                state.points = data.points || 0;
                state.energy = data.energy !== undefined ? data.energy : 1000;
                document.getElementById('balance-txt').innerText = Math.floor(state.points).toLocaleString();
                document.getElementById('energy-txt').innerText = state.energy;
            } else {
                userRef.set({ points: 0, energy: 1000 });
            }
        });

        // 3. Functions (Made Global for HTML)
        window.nav = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        };

        window.startOrder = async (tokens, pack, sol) => {
            tg.showConfirm(`Purchase ${pack} Pack?`, async (ok) => {
                if (ok) {
                    try {
                        const res = await fetch(`${RENDER_URL}/api/create-payment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId, amount: sol, pack, tokens })
                        });
                        const data = await res.json();
                        if (data.success) {
                            currentOrder = { id: data.paymentId, tokens };
                            document.getElementById('modal-pack-name').innerText = pack;
                            document.getElementById('modal-price').innerText = sol + " SOL";
                            document.getElementById('payModal').classList.add('active');
                            tg.openLink(`solana:${WALLET_ADDRESS}?amount=${sol}`);
                        }
                    } catch (e) { alert("Server Error"); }
                }
            });
        };

        window.verifyPay = async () => {
            const sig = document.getElementById('tx-input').value.trim();
            if (!sig) return alert("Paste Signature First");
            try {
                const res = await fetch(`${RENDER_URL}/api/verify-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId: currentOrder.id, transactionSignature: sig })
                });
                const result = await res.json();
                if (result.success) {
                    alert("Success! Tokens Added.");
                    closeModal();
                } else { alert("Not Verified Yet"); }
            } catch (e) { alert("Error connecting to Blockchain"); }
        };

        window.closeModal = () => {
            document.getElementById('payModal').classList.remove('active');
            currentOrder = null;
        };

        // 4. Tap Event
        document.getElementById('tap-trigger').onclick = () => {
            if (state.energy > 0) {
                state.points++;
                state.energy--;
                userRef.update({ points: state.points, energy: state.energy });
                tg.HapticFeedback.impactOccurred('light');
            }
        };

        // 5. Energy Regen
        setInterval(() => {
            if (state.energy < 1000) {
                state.energy++;
                userRef.child('energy').set(state.energy);
            }
        }, 5000);
    </script>
</body>
</html>
