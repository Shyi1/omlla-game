<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OMLLA | ULTIMATE EMPIRE</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS Reset & Anti-Scroll Protection */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: pan-y; }
        :root { --brand: #F5A623; --brand-dark: #D35400; --bg: #0F0F13; --card: #1C1C24; --text: #FFFFFF; }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Top Header */
        .header { padding: 20px; text-align: center; background: linear-gradient(180deg, rgba(245,166,35,0.1) 0%, transparent 100%); }
        .level-badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 15px; }
        .balance-container { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .balance-amount { font-family: 'Montserrat', sans-serif; font-size: 48px; font-weight: 900; letter-spacing: -1px; text-shadow: 0 4px 15px rgba(245,166,35,0.3); }

        /* Page Routing */
        .page { display: none; flex: 1; overflow-y: auto; padding: 0 20px 100px; animation: slideIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* The Viral Coin Engine */
        .clicker-area { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh; position: relative; }
        .coin-wrapper { position: relative; perspective: 1000px; }
        .game-coin {
            width: 260px; height: 260px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #FFD166 0%, var(--brand) 50%, var(--brand-dark) 100%);
            box-shadow: 0 20px 50px rgba(211,84,0,0.5), inset 0 10px 20px rgba(255,255,255,0.5), inset 0 -10px 20px rgba(0,0,0,0.4);
            border: 8px solid #FFD166; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.05s ease;
        }
        .game-coin:active { transform: scale(0.92) translateY(5px); box-shadow: 0 10px 20px rgba(211,84,0,0.5); }
        .coin-logo { font-size: 80px; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2)); }
        
        /* Floating Tap Effect */
        .tap-float { position: absolute; font-size: 36px; font-weight: 900; color: #FFF; text-shadow: 0 0 10px var(--brand); pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 50; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-150px) scale(1.5); } }

        /* Progress & Energy */
        .stats-panel { background: var(--card); border-radius: 20px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: #AAA; margin-bottom: 8px; }
        .progress-bar { width: 100%; height: 12px; background: #000; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FFD166, var(--brand)); transition: width 0.2s linear; }

        /* Action Cards (Boosts, Tasks) */
        .action-card { background: var(--card); border-radius: 20px; padding: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .action-info h4 { font-size: 16px; font-weight: 900; margin-bottom: 4px; }
        .action-info p { font-size: 12px; color: #888; font-weight: 700; }
        .action-btn { background: var(--brand); color: #000; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.2s; }
        .action-btn:active { transform: scale(0.95); }
        .action-btn:disabled { background: #333; color: #777; }

        /* Bottom Navigation Bar */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(28,28,36,0.95); backdrop-filter: blur(10px); padding: 10px 20px 25px; display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #666; font-size: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--brand); }
        .nav-item i { font-size: 24px; }

        /* Inputs & Modals */
        .form-input { width: 100%; background: #000; border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; color: #FFF; font-size: 14px; font-weight: 700; margin: 15px 0; outline: none; text-align: center; }
        .form-input:focus { border-color: var(--brand); }
    </style>
</head>
<body>

    <header class="header">
        <div class="level-badge"><i class="fas fa-star" style="color: var(--brand);"></i> <span id="level-display">Level 1</span></div>
        <div class="balance-container">
            <i class="fas fa-coins" style="color: var(--brand); font-size: 35px;"></i>
            <div class="balance-amount" id="main-balance">0</div>
        </div>
    </header>

    <main id="page-mine" class="page active">
        <div class="clicker-area">
            <div class="coin-wrapper" id="click-target">
                <div class="game-coin">
                    <div class="coin-logo">üê¢</div>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-header">
                <span style="color: var(--brand);"><i class="fas fa-bolt"></i> Energy</span>
                <span id="energy-text">1000 / 1000</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="energy-bar" style="width: 100%;"></div></div>
        </div>
    </main>

    <main id="page-boost" class="page">
        <h3 style="margin-bottom: 15px; font-weight: 900; font-size: 20px;">Boosters</h3>
        
        <div class="action-card">
            <div class="action-info">
                <h4><i class="fas fa-hand-pointer" style="color: var(--brand);"></i> Multi-Tap</h4>
                <p>+1 Coin per tap</p>
                <p style="color: var(--brand); margin-top: 5px;" id="tap-cost-text">Cost: 2,000</p>
            </div>
            <button class="action-btn" onclick="buyUpgrade('tap')">Upgrade</button>
        </div>

        <div class="action-card">
            <div class="action-info">
                <h4><i class="fas fa-battery-full" style="color: #14F195;"></i> Energy Limit</h4>
                <p>+500 Max Energy</p>
                <p style="color: var(--brand); margin-top: 5px;" id="energy-cost-text">Cost: 5,000</p>
            </div>
            <button class="action-btn" onclick="buyUpgrade('energy')">Upgrade</button>
        </div>
    </main>

    <main id="page-earn" class="page">
        <h3 style="margin-bottom: 15px; font-weight: 900; font-size: 20px;">Earn More</h3>
        
        <div class="action-card">
            <div class="action-info">
                <h4>Daily Reward</h4>
                <p style="color: #14F195;">+1,000 Coins</p>
            </div>
            <button class="action-btn" onclick="claimDaily()">Claim</button>
        </div>

        <div class="action-card">
            <div class="action-info">
                <h4>Join Community</h4>
                <p style="color: #14F195;">+5,000 Coins</p>
            </div>
            <button class="action-btn" onclick="tg.openLink('https://t.me/omllacapital')">Join</button>
        </div>

        <div class="action-card">
            <div class="action-info">
                <h4>Invite Friends</h4>
                <p style="color: #14F195;">+25,000 / Friend</p>
            </div>
            <button class="action-btn" onclick="shareGame()">Invite</button>
        </div>
    </main>

    <main id="page-wallet" class="page">
        <h3 style="margin-bottom: 15px; font-weight: 900; font-size: 20px;">Airdrop Wallet</h3>
        <div class="stats-panel" style="text-align: center; padding: 30px 15px;">
            <i class="fas fa-wallet" style="font-size: 50px; color: var(--brand); margin-bottom: 15px;"></i>
            <h4 style="margin-bottom: 10px;">Connect Solana Wallet</h4>
            <p style="font-size: 12px; color: #888;">Link your wallet to receive the Omlla token airdrop in Q4 2026.</p>
            <input type="text" id="wallet-input" class="form-input" placeholder="Paste Solana Address Here">
            <button class="action-btn" style="width: 100%; padding: 15px;" onclick="saveWallet()">Connect Wallet</button>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('mine', this)"><i class="fas fa-hammer"></i>Mine</div>
        <div class="nav-item" onclick="switchTab('boost', this)"><i class="fas fa-rocket"></i>Boost</div>
        <div class="nav-item" onclick="switchTab('earn', this)"><i class="fas fa-coins"></i>Earn</div>
        <div class="nav-item" onclick="switchTab('wallet', this)"><i class="fas fa-wallet"></i>Wallet</div>
    </nav>

    <script>
        // --- 1. TELEGRAM & FIREBASE INIT ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const firebaseConfig = {
            databaseURL: "https://omllagame-default-rtdb.europe-west1.firebasedatabase.app/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Ensure user ID exists (Fallback for testing outside Telegram)
        const userId = tg.initDataUnsafe?.user?.id?.toString() || "web_tester_" + Math.floor(Math.random()*1000);
        const userRef = db.ref('players/' + userId);

        // --- 2. GAME STATE MANAGEMENT ---
        let state = {
            balance: 0,
            energy: 1000,
            maxEnergy: 1000,
            tapPower: 1,
            tapCost: 2000,
            energyCost: 5000,
            lastSave: Date.now()
        };

        // Load data from Firebase
        userRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                state = { ...state, ...snapshot.val() };
            } else {
                // First time user
                userRef.set(state);
            }
            updateUI();
        });

        // --- 3. CORE LOGIC (THE CLICKER) ---
        let pendingSaves = 0;

        document.getElementById('click-target').addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevents double-tap zooming and scrolling
            
            // Energy Validation (Anti-Cheat)
            if (state.energy < state.tapPower) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            // Apply Logic
            state.balance += state.tapPower;
            state.energy -= state.tapPower;
            pendingSaves++;

            // Visual & Haptic Feedback
            const touches = e.changedTouches;
            for (let i = 0; i < touches.length; i++) {
                createFloatingNumber(touches[i].clientX, touches[i].clientY);
            }
            tg.HapticFeedback.impactOccurred('medium');
            
            updateUI();
        }, { passive: false });

        // Visual Effect Generator
        function createFloatingNumber(x, y) {
            const el = document.createElement('div');
            el.className = 'tap-float';
            el.innerText = `+${state.tapPower}`;
            el.style.left = `${x - 20}px`;
            el.style.top = `${y - 40}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // --- 4. DATA SYNCHRONIZATION (PROTECTION) ---
        // Save to Firebase every 3 seconds IF there are changes to prevent lag
        setInterval(() => {
            if (pendingSaves > 0) {
                userRef.update({
                    balance: state.balance,
                    energy: state.energy,
                    tapPower: state.tapPower,
                    maxEnergy: state.maxEnergy,
                    tapCost: state.tapCost,
                    energyCost: state.energyCost
                });
                pendingSaves = 0;
            }
        }, 3000);

        // Energy Regeneration Loop (3 units every second)
        setInterval(() => {
            if (state.energy < state.maxEnergy) {
                state.energy = Math.min(state.energy + 3, state.maxEnergy);
                updateUI();
            }
        }, 1000);

        // --- 5. UPGRADES & TASKS ---
        window.buyUpgrade = function(type) {
            if (type === 'tap') {
                if (state.balance >= state.tapCost) {
                    state.balance -= state.tapCost;
                    state.tapPower += 1;
                    state.tapCost = Math.floor(state.tapCost * 2.5); // Increase price
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert("Not enough coins!");
                }
            } else if (type === 'energy') {
                if (state.balance >= state.energyCost) {
                    state.balance -= state.energyCost;
                    state.maxEnergy += 500;
                    state.energyCost = Math.floor(state.energyCost * 2.0); // Increase price
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert("Not enough coins!");
                }
            }
            pendingSaves++;
            updateUI();
        };

        window.claimDaily = function() {
            state.balance += 1000;
            pendingSaves++;
            updateUI();
            tg.showAlert("Daily Reward Claimed: +1,000 Coins");
        };

        window.shareGame = function() {
            const refLink = `https://t.me/YourBotUsername?start=ref_${userId}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(refLink)}&text=Play Omlla and earn crypto!`);
        };

        window.saveWallet = function() {
            const addr = document.getElementById('wallet-input').value.trim();
            if (addr.length < 32) {
                tg.showAlert("Please enter a valid Solana address.");
                return;
            }
            userRef.child('wallet').set(addr);
            tg.showAlert("Wallet successfully linked for the 2026 Airdrop!");
        };

        // --- 6. UI MANAGEMENT ---
        function updateUI() {
            // Balance format (e.g., 1,234,567)
            document.getElementById('main-balance').innerText = Math.floor(state.balance).toLocaleString();
            
            // Energy format
            document.getElementById('energy-text').innerText = `${Math.floor(state.energy)} / ${state.maxEnergy}`;
            document.getElementById('energy-bar').style.width = `${(state.energy / state.maxEnergy) * 100}%`;
            
            // Calculate Level based on Balance
            const level = Math.floor(Math.pow(state.balance / 1000, 0.5)) + 1;
            document.getElementById('level-display').innerText = `Level ${level}`;

            // Update Boost Costs
            document.getElementById('tap-cost-text').innerText = `Cost: ${state.tapCost.toLocaleString()}`;
            document.getElementById('energy-cost-text').innerText = `Cost: ${state.energyCost.toLocaleString()}`;
        }

        window.switchTab = function(tabId, element) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            // Show target page
            document.getElementById('page-' + tabId).classList.add('active');
            
            // Update nav styling
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            element.classList.add('active');
            
            tg.HapticFeedback.impactOccurred('light');
        };

    </script>
</body>
</html>
